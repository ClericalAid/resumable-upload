<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <input type="file" id="fileToUpload">
    <input type="button" onclick="pauseUpload()" value="Pause">
    <input type="button" onclick="resumeUpload()" value="Resume">
    <input type="submit" onclick="submitFiles()">
    <p id= "progressIndicator"></p>
  </body>
</html>

<script>
var chunkSize = 5*1024*1024;
var locationURI;
var pauseRequested = false;
var resumingUpload = false;
var beginningUpload = true;
var progressIndicator;
var file;

const CONTINUE_UPLOAD = 308;
const UPLOAD_COMPLETE = 200;
const UPLOADING_TEXT = "Uploading... "

/**
 *  submitFiles
 *    Gets the authentication token and runs the uploadFile function with it.
 */
async function submitFiles(){
  var allFiles = document.getElementById("fileToUpload").files;
  if (allFiles.size == 0){
    console.log("No files were found");
    return false;
  }
  file = allFiles[0];
  google.script.run.withSuccessHandler(getLocationURI).getAuthenticationToken();
}

/**
 *  uploadFile()
 *
 *  1)  Divides the files into chunks
 *  2)  Verifies whether we are resuming an upload, or starting from scratch
 *    2a) Starting from scratch:
 *        Upload the file starting from chunk 0
 *    2b) Starting from a resume point:
 *        Upload the file starting from the resume point?
 */
async function uploadFile(){
  progressIndicator = document.getElementById("progressIndicator");
  var startingChunk = 0;
  
  // 1) Dividing the files into chunks
  fileChunks = divideFile(file);

  // 2a) Starting from scratch, meaning we have been called by the rest request

  // 2b) We are resuming from some arbitrary point

  // 3) Begin uploading the files in chunks
  progressIndicator.innerHTML = UPLOADING_TEXT;
  console.log(locationURI);
  for (var i = startingChunk; i < fileChunks.chunkCount; ++i){
    var offset = chunkSize * i;
    var chunkEnd = offset + fileChunks.chunkArray[i].size - 1;
    contentRange = "bytes " + offset + "-" + chunkEnd + "/" + fileChunks.fileSize;
    var chunkStatus = await uploadChunk(locationURI, fileChunks.chunkArray[i], contentRange);
    if (chunkStatus == UPLOAD_COMPLETE){
      progressIndicator.innerHTML = UPLOADING_TEXT  + "100%"
    }
    if (chunkStatus == CONTINUE_UPLOAD){
      var percentageProgress = chunkEnd / fileChunks.fileSize * 100;
      progressIndicator.innerHTML = UPLOADING_TEXT + percentageProgress.toPrecision(5)  + "%";
    }
    if (pauseRequested == true){
      progressIndicator.innerHTML = "Upload paused"
      return;
    }
  }
}

/**
 *  pauseUpload
 *  Pauses the upload by switching a global boolean
 */
function pauseUpload(){
  pauseRequested = true;
  console.log(locationURI);
}

/**
 *  resumeUpload
 *  Tries to resume the upload? Via the main loop? Can the main loop do this?
 */
function resumeUpload(){
  pauseRequested = false;
  if (locationURI){
    resumingUpload = true;
  }
  console.log(locationURI); 
  uploadFile();
}

/**
 *  getLocationURI
 *  parameters:
 *    authenticationToken
 */
function getLocationURI(authenticationToken){
  console.log("Token: " + authenticationToken);

  var requestPromise = new Promise(function(resolve, reject) {
    var restRequest = new XMLHttpRequest();
    restRequest.open("POST", "https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable");
    restRequest.setRequestHeader('Authorization', "Bearer " + authenticationToken);
    restRequest.setRequestHeader('Content-Type', "application/json");
    restRequest.onload = () => resolve(restRequest.getResponseHeader("location"));
    restRequest.onerror = () => reject(null);
    restRequest.send(JSON.stringify({
      mimeType: file.type,
      name: file.name
    }));
  });

  requestPromise.then(function(responseHeader){
    if (responseHeader == null){
      console.log("No response header");
      return;
    }
    locationURI = responseHeader;
    uploadFile();
  });
}

/**
 *  divideFile
 *  parameters:
 *    file
 *      The file object which will be split into chunks
 *  Splits a file into chunks and returns the object which organizes said chunks
 *
 *  Calculate the total amount of chunks by dividing the file size by the chunk size. Split up
 *  said file into chunks and push them into an array.
 */
function divideFile(file){
  var fileChunks = {};
  fileChunks.fileSize = file.size;
  fileChunks.chunkCount = Math.ceil(file.size/chunkSize);
  fileChunks.chunkArray = new Array();
  for (var i = 0; i < fileChunks.chunkCount; ++i){
    offset = chunkSize*i;
    fileChunks.chunkArray.push(file.slice(offset, offset + chunkSize));
  }
  
  console.log(fileChunks);
 
  return fileChunks;
}

/**
 *  uploadChunk
 *  parameters:
 *    locationURI
 *      The URI of where the file will be uploaded to
 *    chunk
 *      The "chunk" of the file that we are uploading
 *    contentRange
 *      The description of the bytes that we are uploading. E.g. "bytes 0-10000/50000"
 *  Uploads a segment of a file to the specified URI. The settings are toggled to work
 *  with google drive.
 *  TODO: Add onedrive functionality? With a google script? Awesome!
 */
function uploadChunk(locationURI, chunk, contentRange) {
  return new Promise((resolve, reject) => {
    var uploadChunkRequest = new XMLHttpRequest();
    uploadChunkRequest.open("PUT", locationURI);
    uploadChunkRequest.setRequestHeader('Content-Range', contentRange);
    uploadChunkRequest.onload = () => resolve(uploadChunkRequest.status);
    uploadChunkRequest.onerror = () => reject(uploadChunkRequest.status);
    uploadChunkRequest.send(chunk);
  });
}
</script>
