<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <input type="file" id="fileToUpload">
    <input type="button" onclick="pauseUpload()" value="Pause">
    <input type="button" onclick="resumeUpload()" value="Resume">
    <input type="submit" onclick="submitFiles()">
    <p id= "progressIndicator"></p>
  </body>
</html>

<script>
var chunkSize = 5*1024*1024;
var locationURI = null;
var pauseRequested = false;
var resumingUpload = false;
var beginningUpload = true;
var progressIndicator;
var file;
var fileChunks;

const CONTINUE_UPLOAD = 308;
const UPLOAD_COMPLETE = 200;
const SERVICE_UNAVAILABLE = 503;
const UPLOADING_TEXT = "Uploading... "
const FIVE_SECONDS = 5000;

/**
 *  submitFiles
 *    Gets the authentication token and runs the uploadFile function with it.
 *  We divide the file into chunks, and then proceed to upload it
 */
async function submitFiles(){
  pauseRequested = false;
  var allFiles = document.getElementById("fileToUpload").files;
  if (allFiles.size == 0){
    console.log("No files were found");
    return false;
  }
  file = allFiles[0];
  fileChunks = divideFile(file);
  google.script.run.withSuccessHandler(getLocationURI).getAuthenticationToken();
}

/**
 *  uploadFile()
 *  parameters
 *    startingChunk
 *      The chunk where we are starting (an integer which depicts the array index to start at)
 *  Uploads the file starting from the starting chunk that was passed in.
 */
async function uploadFile(startingChunk = 0){
  progressIndicator = document.getElementById("progressIndicator");

  progressIndicator.innerHTML = UPLOADING_TEXT;
  console.log(locationURI);
  for (var i = startingChunk; i < fileChunks.chunkCount; ++i){
    if (pauseRequested == true){
      progressIndicator.innerHTML = "Upload paused"
      return;
    }

    var offset = chunkSize * i + fileChunks.firstByte;
    var chunkEnd = offset + fileChunks.chunkArray[i].size - 1;
    var contentRange = "bytes " + offset + "-" + chunkEnd + "/" + fileChunks.fileSize;
    console.log(contentRange);
    try{
      var chunkStatus = await uploadChunk(locationURI, fileChunks.chunkArray[i], contentRange);
    }
    catch{
      progressIndicator.innerHTML = "Check your internet connection and attempt to resume";
      return;
    }
    if (chunkStatus == UPLOAD_COMPLETE){
      progressIndicator.innerHTML = UPLOADING_TEXT  + "100%"
    }
    else if (chunkStatus == CONTINUE_UPLOAD){
      var percentageProgress = chunkEnd / fileChunks.fileSize * 100;
      progressIndicator.innerHTML = UPLOADING_TEXT + percentageProgress.toPrecision(5)  + "%";
    }
    else if (chunkStatus == SERVICE_UNAVAILABLE){
      progressIndicator.innerHTML = "Check your internet connection and attempt to resume";
      return;
    }
    else{
      progressIndicator.innerHTML = "Check your internet connection and attempt to resume";
      return;
    }
  }
}

/**
 *  pauseUpload
 *  Pauses the upload by switching a global boolean
 */
function pauseUpload(){
  pauseRequested = true;
  progressIndicator = document.getElementById("progressIndicator");
  progressIndicator.innerHTML = "Pausing upload...";
}

/**
 *  resumeUpload
 *  1) Call google to find where we are in the file upload
 *  2) Set up a new starting point in the file upload
 *  3) Resume the upload from that starting point
 */
function resumeUpload(){
  pauseRequested = false;
  progressIndicator = document.getElementById("progressIndicator");
  progressIndicator.innerHTML = "Resuming upload...";

  if (locationURI == null){
    console.log("No upload to resume!");
    return;
  }

  console.log(locationURI); 

  var contentRange = "bytes */" + fileChunks.fileSize;

  // 1)
  var requestPromise = new Promise(function(resolve, reject) {
    var restRequest = new XMLHttpRequest();
    restRequest.open("PUT", locationURI);
    restRequest.setRequestHeader('Content-Range', contentRange);
    restRequest.onload = () => resolve(restRequest.getResponseHeader("Range"));
    restRequest.onerror = () => reject(null);
    restRequest.send();
  });

  requestPromise.then(function(responseRange){
    if (responseRange == null){
      return false;
    }

    parsedResponse = responseRange.split("-");

    // 2)
    var bytesUploaded = parseInt(parsedResponse.pop());
    bytesUploaded += 1;
    fileChunks = divideFile(file, bytesUploaded);

    console.log(responseRange);

    // 3)
    uploadFile();
  });
}

/**
 *  getLocationURI
 *  parameters:
 *    authenticationToken
 */
function getLocationURI(authenticationToken){
  console.log("Token: " + authenticationToken);

  var requestPromise = new Promise(function(resolve, reject) {
    var restRequest = new XMLHttpRequest();
    restRequest.open("POST", "https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable");
    restRequest.setRequestHeader('Authorization', "Bearer " + authenticationToken);
    restRequest.setRequestHeader('Content-Type', "application/json");
    restRequest.onload = () => resolve(restRequest.getResponseHeader("location"));
    restRequest.onerror = () => reject(null);
    restRequest.send(JSON.stringify({
      mimeType: file.type,
      name: file.name
    }));
  });

  requestPromise.then(function(responseHeader){
    if (responseHeader == null){
      console.log("No response header");
      return;
    }

    locationURI = responseHeader;
    uploadFile();
  });
}

/**
 *  divideFile
 *  parameters:
 *    file
 *      The file object which will be split into chunks
 *    firstByte
 *      The first byte which we wish to upload. For example: if the file is 20,000,000 bytes large,
 *      and we wish to upload the second half of it, then we set firstByte to 10,000,000
 *  Splits a file into chunks and returns the object which organizes said chunks
 *
 *  Calculate the total amount of chunks by dividing the file size by the chunk size. Split up
 *  said file into chunks and push them into an array.
 */
function divideFile(file, firstByte = 0){
  var blobChunks = {};
  blobChunks.fileSize = file.size;
  blobChunks.chunkCount = Math.ceil((file.size - firstByte)/chunkSize);
  blobChunks.chunkArray = new Array();
  blobChunks.firstByte = firstByte;
  for (var i = 0; i < blobChunks.chunkCount; ++i){
    offset = chunkSize*i + firstByte;
    blobChunks.chunkArray.push(file.slice(offset, offset + chunkSize));
  }
  
  console.log(blobChunks);
 
  return blobChunks;
}

/**
 *  uploadChunk
 *  parameters:
 *    locationURI
 *      The URI of where the file will be uploaded to
 *    chunk
 *      The "chunk" of the file that we are uploading
 *    contentRange
 *      The description of the bytes that we are uploading. E.g. "bytes 0-10000/50000"
 *  Uploads a segment of a file to the specified URI. The settings are toggled to work
 *  with google drive.
 *  TODO: Add onedrive functionality? With a google script? Awesome!
 */
function uploadChunk(locationURI, chunk, contentRange) {
  return new Promise((resolve, reject) => {
    var uploadChunkRequest = new XMLHttpRequest();
    uploadChunkRequest.open("PUT", locationURI);
    uploadChunkRequest.setRequestHeader('Content-Range', contentRange);
    uploadChunkRequest.onload = () => resolve(uploadChunkRequest.status);
    uploadChunkRequest.onerror = () => reject(uploadChunkRequest.status);
    uploadChunkRequest.send(chunk);
  });
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
</script>
